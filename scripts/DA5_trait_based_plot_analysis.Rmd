---
title: "PFTC Fire: Trait based plots and analysis"
authors: "Sonya R. Geange and Ragnhild Gya"
output: html_notebook
---

```{r}
library(vegan)
library(ape)
library(dplyr)
library(tidyverse)
library(ggplot2)


# Load dataset from OSF repository
source(here::here(path = "scripts/0_data_import.R"))

traits_wide <- traits %>% pivot_wider(names_from = c(trait),
                                      values_from = c(value)) %>% mutate(plot_id = paste0(site,"_" ,plot_id))

```


# Plot all data, site by elevation comparisons

Using 'site' rather than elevation for the plots, but in the analysis need the nested nature of plots within sites.

(Yes, we know we could make a function to not replicate plot code, we were just lazy/out of time)

```{r}

# Site by elevation
traits$site <- factor(traits$site, 
                    levels = c("ACJ", "TRE", "QUE"))


traits %>%
  filter(
    trait %in% c('plant_height_cm', 'sla_cm2_g', 'ldmc',
                 'leaf_thickness_ave_mm', 'leaf_area_cm2')
    ) %>%
    mutate(
         trait = case_when(trait == "plant_height_cm" ~ "Plant~height~(cm)",
                           trait == "sla_cm2_g" ~ "SLA~(cm^{2}/g)",
                           trait == "ldmc" ~ "LDMC",
                           trait == "leaf_thickness_mm" ~ "Leaf~thickness~(mm)",
                           trait == "leaf_area_cm2" ~ "Leaf~area~cm^{2}")
         ) %>%
  ggplot() +
  geom_boxplot(aes(x = site,
                   y = log(value), 
                   fill = treatment), 
               na.rm = TRUE,
               position = "dodge2") +
  facet_wrap(vars(trait),
             scales = 'free',
             labeller = label_parsed) +
  # Choose manual colours
  scale_fill_manual(values = c("darkgreen", "orange"),
                    name = "Burn Treatment") +
  theme_classic() +
  labs(x = "Site",
       y = "Trait value (log transformed)") +
  theme(legend.position = "bottom")


```

# Basic Analysis
```{r all_data_analysis}
library(lme4)
library(lmerTest)

# Models for all datasets (years, seasons)
# NB. Now run with season and functional group added in when using complete dataset (i.e. Puna and PFTC data from 2018-2020 and wet/dry seasons). NOTE: When using community weighted means, we won't keep functional group. Similarly for wet and dry only, the season term would be removed. 

# Scaling issues - can't resolve with elevation.
# SLA
SLA_analysis <- lmer(log(sla_cm2_g) ~ treatment*elevation + (1|plot_id) + (1|family/taxon) + (1|functional_group) + (1|season), data = traits_wide)
anova(SLA_analysis)
summary(SLA_analysis)

# Leaf Area
LA_analysis <- lmer(log(leaf_area_cm2) ~ treatment*elevation + (1|plot_id) + (1|family/taxon)+ (1|functional_group) + (1|season), data = traits_wide)
anova(LA_analysis)
summary(LA_analysis)

# Plant Height
PlantHeight_analysis <- lmer(log(plant_height_cm) ~ treatment*elevation + (1|plot_id) + (1|family/taxon)+ (1|functional_group) + (1|season), data = traits_wide)
anova(PlantHeight_analysis)
summary(PlantHeight_analysis)

# Leaf thickness
LeafThickness_analysis <- lmer(log(leaf_thickness_mm) ~ treatment*elevation + (1|plot_id) + (1|family/taxon)+ (1|functional_group) + (1|season), data = traits_wide)
anova(LeafThickness_analysis)
summary(LeafThickness_analysis)

# LDMC
LDMC_analysis <- lmer(ldmc ~ treatment*elevation + (1|plot_id) + (1|family/taxon)+ (1|functional_group) + (1|season), data = traits_wide)
anova(LDMC_analysis)
summary(LDMC_analysis)
```

# Dry season only plots and analysis

```{r}
# look at only dry season indices

traits_wide_dry <- traits_wide %>% 
  filter(c(season == "dry_season"))

traits %>%
  filter(
    trait %in% c('plant_height_cm', 'sla_cm2_g', 'ldmc',
                 'leaf_thickness_ave_mm', 'leaf_area_cm2') &&
      season == "dry_season"
    ) %>%
    mutate(
         trait = case_when(trait == "plant_height_cm" ~ "Plant~height~(cm)",
                           trait == "sla_cm2_g" ~ "SLA~(cm^{2}/g)",
                           trait == "ldmc" ~ "LDMC",
                           trait == "leaf_thickness_mm" ~ "Leaf~thickness~(mm)",
                           trait == "leaf_area_cm2" ~ "Leaf~area~cm^{2}")
         ) %>%
  ggplot() +
  geom_boxplot(aes(x = site,
                   y = log(value), 
                   fill = treatment), 
               na.rm = TRUE,
               position = "dodge2") +
  facet_wrap(vars(trait),
             scales = 'free',
             labeller = label_parsed) +
  # Choose manual colours
  scale_fill_manual(values = c("darkgreen", "orange"),
                    name = "Burn Treatment") +
  theme_classic() +
  labs(x = "Site",
       y = "Trait value (log transformed)") +
  theme(legend.position = "bottom")


# Analysis

# SLA
SLA_analysis_dry <- lmer(log(sla_cm2_g) ~ treatment*elevation + (1|plot_id) + (1|family/taxon) + (1|functional_group), data = traits_wide_dry)
anova(SLA_analysis_dry)
summary(SLA_analysis_dry)

# Leaf Area
LA_analysis_dry <- lmer(log(leaf_area_cm2) ~ treatment*elevation + (1|plot_id) + (1|family/taxon) + (1|functional_group), data = traits_wide_dry)
anova(LA_analysis_dry)
summary(LA_analysis_dry)

# Plant Height
PlantHeight_analysis_dry <- lmer(log(plant_height_cm) ~ treatment*elevation + (1|plot_id) + (1|family/taxon) + (1|functional_group), data = traits_wide_dry)
anova(PlantHeight_analysis_dry)
summary(PlantHeight_analysis_dry)

# Leaf thickness
LeafThickness_analysis_dry <- lmer(log(leaf_thickness_mm) ~ treatment*elevation + (1|plot_id) + (1|family/taxon) + (1|functional_group), data = traits_wide_dry)
anova(LeafThickness_analysis_dry)
summary(LeafThickness_analysis_dry)

# LDMC
LDMC_analysis_dry <- lmer(ldmc ~ treatment*elevation + (1|plot_id) + (1|family/taxon) + (1|functional_group), data = traits_wide_dry)
anova(LDMC_analysis_dry)
summary(LDMC_analysis_dry)
```

# Wet season only plots and analysis

```{r}


traits %>%
  filter(
    trait %in% c('plant_height_cm', 'sla_cm2_g', 'ldmc',
                 'leaf_thickness_ave_mm', 'leaf_area_cm2') &&
      season == "wet_season"
    ) %>%
    mutate(
         trait = case_when(trait == "plant_height_cm" ~ "Plant~height~(cm)",
                           trait == "sla_cm2_g" ~ "SLA~(cm^{2}/g)",
                           trait == "ldmc" ~ "LDMC",
                           trait == "leaf_thickness_mm" ~ "Leaf~thickness~(mm)",
                           trait == "leaf_area_cm2" ~ "Leaf~area~cm^{2}")
         ) %>%
  ggplot() +
  geom_boxplot(aes(x = site,
                   y = log(value), 
                   fill = treatment), 
               na.rm = TRUE,
               position = "dodge2") +
  facet_wrap(vars(trait),
             scales = 'free',
             labeller = label_parsed) +
  # Choose manual colours
  scale_fill_manual(values = c("darkgreen", "orange"),
                    name = "Burn Treatment") +
  theme_classic() +
  labs(x = "Site",
       y = "Trait value (log transformed)") +
  theme(legend.position = "bottom")

# Analysis
traits_wide_wet <- traits_wide %>% 
  filter(c(season == "wet_season"))

# SLA
SLA_analysis_wet <- lmer(log(sla_cm2_g) ~ treatment*elevation + (1|plot_id) + (1|family/taxon)+ (1|functional_group), data = traits_wide_wet)
anova(SLA_analysis_wet)
summary(SLA_analysis_wet)

# Leaf Area
LA_analysis_wet <- lmer(log(leaf_area_cm2) ~ treatment*elevation + (1|plot_id) + (1|family/taxon)+ (1|functional_group), data = traits_wide_wet)
anova(LA_analysis_wet)
summary(LA_analysis_wet)


# Plant Height
PlantHeight_analysis_wet <- lmer(log(plant_height_cm) ~ treatment*elevation + (1|plot_id) + (1|family/taxon)+ (1|functional_group), data = traits_wide_wet)
anova(PlantHeight_analysis_wet)
summary(PlantHeight_analysis_wet)

# Leaf thickness
LeafThickness_analysis_wet <- lmer(log(leaf_thickness_mm) ~ treatment*elevation + (1|plot_id) + (1|family/taxon) + (1|functional_group), data = traits_wide_wet)
anova(LeafThickness_analysis_wet)
summary(LeafThickness_analysis_wet)

# LDMC
LDMC_analysis_wet <- lmer(ldmc ~ treatment*elevation + (1|plot_id) + (1|family/taxon)+ (1|functional_group), data = traits_wide_wet)
anova(LDMC_analysis_wet)
summary(LDMC_analysis_wet)
```


# Preliminary Look at Functional Groups (Wet Season Only)

```{r}
(SLA_plot_wet_FG <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = sla_cm2_g, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(SLA_cm2_g)) +
    theme_classic() +
    theme(legend.position = "bottom"))

(PlantHeight_plot_wet_FG <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = log(plant_height_cm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(log(Plant~Height,cm))) +
    theme_classic() +
    theme(legend.position = "bottom"))


(LeafArea_plot_wet_FG <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = log(leaf_area_cm2), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(log(Leaf~Area, cm2))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LeafThickness_plot_wet_FG <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = log(leaf_thickness_mm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(log(Leaf~Thickness, mm))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LDMC_plot_wet <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = ldmc, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(Leaf~Dry~Matter~Content)) +
    theme_classic() +
    theme(legend.position = "bottom"))

```

# Use the Trait-strapped data instead
```{r}
# Load new datasets from imputations
traits_ts <- read.csv("./data/processed/traits_traitstrapped_raw.csv", header = TRUE)
traits_wide_ts <- traits_ts %>% pivot_wider(names_from = c(trait),
                                      values_from = c(value))

# Community weighted means instead
traits_CWM <- read.csv("data/processed/traits_traitstrapped_moments.csv", header = TRUE)
traits_CWM <- traits_CWM %>% select(-X) %>% filter(moment == "mean") 

```

# Community weighted mean plots

```{r}

# Site by elevation
traits_CWM$site <- factor(traits_CWM$site, 
                    levels = c("ACJ", "TRE", "QUE"))

(traits_CWM %>%
  filter(
    trait %in% c('plant_height_cm', 'sla_cm2_g', 'ldmc',
                 'leaf_thickness_ave_mm', 'leaf_area_cm2')
    ) %>%
    mutate(
         trait = case_when(trait == "plant_height_cm" ~ "Plant~height~(cm)",
                           trait == "sla_cm2_g" ~ "SLA~(cm^{2}/g)",
                           trait == "ldmc" ~ "LDMC",
                           trait == "leaf_thickness_mm" ~ "Leaf~thickness~(mm)",
                           trait == "leaf_area_cm2" ~ "Leaf~area~cm^{2}")
         ) %>%
  ggplot() +
geom_pointrange(aes(x=site, y=log(estimate),
                    ymin=log(ci_low), ymax=log(ci_high),
                    color = treatment),
                    width=0.2,
                    position = position_dodge(width = 0.3),
                    shape = 20) +
  facet_wrap(vars(trait),
             scales = 'free',
             labeller = label_parsed) +
  # Choose manual colours
  scale_color_manual(values = c("darkgreen", "orange"),
                    name = "Burn Treatment") +
  theme_classic() +
  labs(x = "Site",
       y = "Trait value (log transformed)") +
  theme(legend.position = "bottom"))

```

# Community Weighted Mean Analyses
Still a work in progress. Need to change formatting to match new CWM bootstrapped datasets.

```{r}
# No elevation values here, so check original dataset
elev_data <- traits_wide %>%  ungroup() %>% select(site, treatment, plot_id, elevation) %>% unique() %>% view()

# Found some seedlings... probably should remove in script 0.
# Also likely to influence trait-strap estimates?
traits %>% filter(is.na(plot_id))

# Create elevation from original dataset
traits_CWM <- traits_CWM %>% left_join(elev_data, by = c("site", "treatment", "plot_id"))

         
# Pivot wider
traits_CWM_wide <- traits_CWM %>% select(-c(ci_high, ci_low)) %>% 
  pivot_wider(names_from = c(trait), values_from = c(estimate)) %>% mutate(plot_id = paste0(site,"_" ,plot_id))


### Linear mixed effects models
# Warning regarding scaling - can't really do much about elevation. 
# SLA
SLA_analysis_CWM <- lmer(log(sla_cm2_g) ~ treatment*elevation + (1|plot_id),
                         data = traits_CWM_wide)
anova(SLA_analysis_CWM)
summary(SLA_analysis_CWM)

# Leaf Area
LA_analysis_CWM <- lmer(log(leaf_area_cm2) ~ treatment*elevation + (1|plot_id),
                        data = traits_CWM_wide)
anova(LA_analysis_CWM)
summary(LA_analysis_CWM)

# Plant Height
PlantHeight_analysis_CWM <- lmer(log(plant_height_cm) ~ treatment*elevation + (1|plot_id), data = traits_CWM_wide)
anova(PlantHeight_analysis_CWM)
summary(PlantHeight_analysis_CWM)

# Leaf thickness
LeafThickness_analysis_CWM <- lmer(log(leaf_thickness_mm) ~ treatment*elevation + (1|plot_id), data = traits_CWM_wide)
anova(LeafThickness_analysis_CWM)
summary(LeafThickness_analysis_CWM)

# LDMC
LDMC_analysis_CWM <- lmer(ldmc ~ treatment*elevation + (1|plot_id),
                          data = traits_CWM_wide)
anova(LDMC_analysis_CWM)
summary(LDMC_analysis_CWM)
```



# Predicted mean plots for Community Weighted Means

```{r}

```

